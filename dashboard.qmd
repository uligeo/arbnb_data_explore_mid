---
title: "Airbnb Mérida - Nov 2025"
author: "EcoData"
format:
  dashboard:
    theme: cosmo
    logo: https://upload.wikimedia.org/wikipedia/commons/6/69/Airbnb_Logo_B%C3%A9lo.svg
    orientation: columns
---

```{r}
#| label: setup
#| include: false

library(sf)
library(dplyr)
library(mapgl)
library(ggplot2)
library(plotly)
library(tidyr)
library(DT)
library(tibble)
library(scales)
library(viridis)

listings <- st_read("outputs/01_listings_core.geojson", quiet = TRUE)
price_breakdown <- st_read("outputs/03_price_breakdown.geojson", quiet = TRUE)
geographic_quadrants <- st_read("outputs/12_geographic_quadrants.geojson", quiet = TRUE)
property_locations <- st_read("outputs/13_property_locations_enhanced.geojson", quiet = TRUE)
booking_windows <- st_read("outputs/14_booking_windows.geojson", quiet = TRUE)
seasonal_pricing <- st_read("outputs/15_seasonal_pricing.geojson", quiet = TRUE)
stay_duration <- st_read("outputs/16_stay_duration_analysis.geojson", quiet = TRUE)
rating_segments <- st_read("outputs/17_rating_segments.geojson", quiet = TRUE)
review_analysis <- st_read("outputs/18_review_analysis.geojson", quiet = TRUE)
superhost_analysis <- st_read("outputs/19_superhost_analysis.geojson", quiet = TRUE)
property_types <- st_read("outputs/20_property_types.geojson", quiet = TRUE)
property_capacity <- st_read("outputs/21_property_capacity.geojson", quiet = TRUE)
competitive_analysis <- st_read("outputs/22_competitive_analysis.geojson", quiet = TRUE)
property_badges <- st_read("outputs/07_property_badges.geojson", quiet = TRUE)
payment_policies <- st_read("outputs/08_payment_policies.geojson", quiet = TRUE)
image_urls <- st_read("outputs/05_image_urls.geojson", quiet = TRUE)
# Hex data se generan corriendo `Rscript prepare_hex_layers.R`
hex_demographics <- st_read("outputs/23_hex_demographics.geojson", quiet = TRUE)
hex_environment <- st_read("outputs/24_hex_environment.geojson", quiet = TRUE)
hex_mobility <- st_read("outputs/25_hex_mobility.geojson", quiet = TRUE)

merida_center <- c(-89.6167, 20.9667)

parse_mxn_amount <- function(text) {
  if (is.null(text) || length(text) == 0 || is.na(text) || identical(text, "")) {
    return(NA_real_)
  }
  amount_text <- stringr::str_extract(text, "\\$\\s*[0-9\\.,]+")
  if (is.na(amount_text) || length(amount_text) == 0) {
    return(NA_real_)
  }
  numeric_part <- stringr::str_remove_all(amount_text, "\\$")
  numeric_part <- stringr::str_trim(numeric_part)
  if (stringr::str_detect(numeric_part, ",")) {
    numeric_part <- stringr::str_replace_all(numeric_part, "\\.", "")
    numeric_part <- stringr::str_replace(numeric_part, ",", ".")
  } else {
    numeric_part <- stringr::str_replace_all(numeric_part, ",", "")
  }
  suppressWarnings(as.numeric(numeric_part))
}

price_lookup <- price_breakdown |>
  st_drop_geometry() |>
  arrange(room_id, breakdown_order) |>
  group_by(room_id) |>
  summarise(
    breakdown_amount = dplyr::first(breakdown_amount),
    breakdown_description = dplyr::first(breakdown_description),
    quoted_total_mxn = parse_mxn_amount(breakdown_description),
    correction_factor = if_else(
      !is.na(quoted_total_mxn) & !is.na(breakdown_amount) & breakdown_amount > 0,
      quoted_total_mxn / breakdown_amount,
      NA_real_
    ),
    .groups = "drop"
  )

listings <- listings |>
  left_join(price_lookup |> select(room_id, quoted_total_mxn, correction_factor), by = "room_id") |>
  mutate(
    precio_total = case_when(
      !is.na(quoted_total_mxn) ~ quoted_total_mxn,
      !is.na(correction_factor) & !is.na(precio_total) ~ precio_total * correction_factor,
      TRUE ~ precio_total
    ),
    price_per_night = if_else(
      !is.na(precio_total) & stay_nights > 0,
      round(precio_total / stay_nights, 2),
      price_per_night
    )
  ) |>
  select(-quoted_total_mxn, -correction_factor)

coords_matrix <- st_coordinates(listings)
valid_coords <- complete.cases(coords_matrix[, 1], coords_matrix[, 2])
min_points_for_clusters <- 10

if (sum(valid_coords) >= min_points_for_clusters) {
  set.seed(123)
  cluster_centers_n <- min(6, sum(valid_coords))
  km_result <- kmeans(
    coords_matrix[valid_coords, , drop = FALSE],
    centers = cluster_centers_n,
    nstart = 25
  )
  cluster_assignments <- rep(NA_integer_, nrow(listings))
  cluster_assignments[valid_coords] <- km_result$cluster

  clusters_sf <- listings |>
    mutate(cluster_id = cluster_assignments) |>
    filter(!is.na(cluster_id))

  cluster_summary <- clusters_sf |>
    st_drop_geometry() |>
    group_by(cluster_id) |>
    summarise(
      total_properties = n(),
      avg_price = mean(precio_total, na.rm = TRUE),
      median_price = median(precio_total, na.rm = TRUE),
      avg_rating = mean(if_else(calificacion > 0, calificacion, NA_real_), na.rm = TRUE),
      avg_price_per_night = mean(price_per_night, na.rm = TRUE),
      center_lon = mean(geometry_lon, na.rm = TRUE),
      center_lat = mean(geometry_lat, na.rm = TRUE),
      .groups = "drop"
    ) |>
    arrange(desc(total_properties))

  cluster_summary_sf <- st_as_sf(
    cluster_summary,
    coords = c("center_lon", "center_lat"),
    crs = 4326,
    remove = FALSE
  )
} else {
  clusters_sf <- listings[0, ] |> mutate(cluster_id = integer())
  cluster_summary <- tibble::tibble(
    cluster_id = integer(),
    total_properties = integer(),
    avg_price = double(),
    median_price = double(),
    avg_rating = double(),
    avg_price_per_night = double(),
    center_lon = double(),
    center_lat = double()
  )
  cluster_summary_sf <- st_as_sf(
    cluster_summary,
    coords = c("center_lon", "center_lat"),
    crs = 4326,
    remove = FALSE
  )
}
```

# Resumen

## Mapa General

```{r}
#| title: Distribución de Propiedades

listings_map <- listings |>
  st_drop_geometry() |>
  mutate(
    precio_cat = case_when(
      precio_total < 500 ~ "Económico",
      precio_total < 1500 ~ "Medio",
      precio_total < 3000 ~ "Alto",
      TRUE ~ "Exclusivo"
    )
  ) |>
  st_as_sf(coords = c("geometry_lon", "geometry_lat"), crs = 4326)

listings_map_popup <- listings_map |>
  mutate(
    popup_info = paste0(
      "<div style='font-family: Arial; max-width: 250px; padding: 8px;'>",
      "<h4 style='margin: 0 0 8px 0; color: #1f2937;'>", substr(name, 1, 40),
      if_else(nchar(name) > 40, "...", ""), "</h4>",
      "<p style='margin: 4px 0; font-size: 13px;'><strong>Precio:</strong> $", round(precio_total, 2), " MXN</p>",
      "<p style='margin: 4px 0; font-size: 13px;'><strong>Por noche:</strong> $", round(price_per_night, 2), " MXN</p>",
      "<p style='margin: 4px 0; font-size: 13px;'><strong>Calificación:</strong> ",
      if_else(calificacion > 0, paste0(round(calificacion, 1), "/5.0 (", num_reseñas, " reseñas)"), "Sin calificar"), "</p>",
      "<p style='margin: 4px 0; font-size: 13px;'><strong>Ubicación:</strong> ", cuadrante_busqueda, "</p>",
      "</div>"
    )
  )

maplibre(
  style = "https://basemaps.cartocdn.com/gl/voyager-gl-style/style.json",
  center = merida_center,
  zoom = 11
) |>
  add_circle_layer(
    id = "points",
    source = listings_map_popup,
    circle_radius = list(
      "interpolate", list("linear"), list("zoom"),
      8, 4, 12, 7, 16, 14
    ),
    circle_color = list(
      "match",
      list("get", "precio_cat"),
      "Económico", "#10b981",
      "Medio", "#3b82f6",
      "Alto", "#6366f1",
      "Exclusivo", "#a855f7",
      "#64748b"
    ),
    circle_opacity = 0.8,
    circle_stroke_width = 2,
    circle_stroke_color = "#ffffff",
    popup = "popup_info"
  ) |>
  add_categorical_legend(
    legend_title = "Categorías de Precio",
    values = c("Económico", "Medio", "Alto", "Exclusivo"),
    colors = c("#10b981", "#3b82f6", "#6366f1", "#a855f7"),
    position = "bottom-right"
  ) |>
  add_navigation_control(position = "top-right") |>
  add_fullscreen_control(position = "top-left")
```

# Propiedades

## Column

### Por Tipo

```{r}
tipo_stats <- property_types |>
  st_drop_geometry() |>
  mutate(
    tipo = case_when(
      grepl("Casa|Villa", title, ignore.case = TRUE) ~ "Casa/Villa",
      grepl("Apartamento", title, ignore.case = TRUE) ~ "Apartamento",
      grepl("Habitacion", title, ignore.case = TRUE) ~ "Habitación",
      TRUE ~ "Otro"
    )
  ) |>
  count(tipo)

ggplotly(
  ggplot(tipo_stats, aes(x = reorder(tipo, n), y = n, fill = tipo)) +
    geom_col() +
    coord_flip() +
    theme_minimal() +
    theme(legend.position = "none")
)
```

## Column

### Tabla de Propiedades con Imágenes

```{r}
#| title: Top 50 Propiedades

tabla_imagenes <- listings |>
  st_drop_geometry() |>
  left_join(
    image_urls |>
      st_drop_geometry() |>
      filter(image_rank == 1) |>
      select(room_id, url),
    by = "room_id"
  ) |>
  left_join(
    property_capacity |> st_drop_geometry() |> select(room_id, num_bedrooms, num_beds),
    by = "room_id"
  ) |>
  mutate(
    Imagen = ifelse(
      !is.na(url),
      paste0('<img src="', url, '" height="70" style="border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">'),
      '<div style="width:90px;height:70px;background:#e5e7eb;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#9ca3af;">Sin imagen</div>'
    )
  ) |>
  select(
    Imagen,
    Nombre = name,
    `Precio` = precio_total,
    `$/Noche` = price_per_night,
    `Rating` = calificacion,
    `Reseñas` = num_reseñas,
    `Dorm.` = num_bedrooms,
    `Camas` = num_beds
  ) |>
  arrange(desc(Precio)) |>
  head(50)

datatable(
  tabla_imagenes,
  escape = FALSE,
  options = list(
    pageLength = 10,
    scrollX = TRUE,
    columnDefs = list(
      list(width = '100px', targets = 0),
      list(className = 'dt-center', targets = c(2:6))
    )
  ),
  rownames = FALSE,
  class = 'cell-border stripe hover'
) |>
  formatCurrency(c('Precio', '$/Noche'), currency = "$", digits = 2, mark = ",") |>
  formatRound('Rating', digits = 2)
```

# Precios

## Row

### Distribución

```{r}
ggplotly(
  listings |>
    st_drop_geometry() |>
    filter(precio_total < 10000) |>
    ggplot(aes(x = precio_total)) +
    geom_histogram(bins = 50, fill = "#3b82f6") +
    labs(x = "Precio Total (MXN)", y = "Cantidad", title = "Distribución de Precios") +
    theme_minimal()
)
```

### Por Temporada

```{r}
ggplotly(
  seasonal_pricing |>
    st_drop_geometry() |>
    filter(precio_total < 10000) |>
    ggplot(aes(x = season_type, y = precio_total)) +
    geom_boxplot(fill = "#3b82f6") +
    labs(x = "Temporada", y = "Precio Total (MXN)", title = "Precios por Temporada") +
    theme_minimal()
)
```

# Calidad

## Row

### Calificadas {.value-box}

```{r}
#| echo: false
rated <- sum(listings$calificacion > 0, na.rm = TRUE)
```

`r format(rated, big.mark = ",")`

### Superhosts {.value-box}

```{r}
#| echo: false
total_superhosts <- superhost_analysis |>
  st_drop_geometry() |>
  filter(host_is_superhost == TRUE) |>
  nrow()
```

`r format(total_superhosts, big.mark = ",")`

### Segmentos

```{r}
ggplotly(
  rating_segments |>
    st_drop_geometry() |>
    ggplot(aes(x = rating_range, y = total_properties)) +
    geom_col(fill = "#10b981") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
)
```


# Geografía

## Column {width=40%}

### Cuadrantes Top

```{r}
#| title: Top 15 Cuadrantes por Propiedades

top_cuad <- geographic_quadrants |>
  st_drop_geometry() |>
  arrange(desc(total_properties)) |>
  head(15) |>
  mutate(cuad_short = stringr::str_trunc(cuadrante_busqueda, 20))

ggplotly(
  ggplot(top_cuad, aes(x = reorder(cuad_short, total_properties),
                       y = total_properties, fill = avg_price)) +
    geom_col() +
    coord_flip() +
    scale_fill_viridis_c(option = "plasma") +
    labs(x = NULL, y = "Propiedades", fill = "Precio\nPromedio") +
    theme_minimal()
)
```

### Mapa de Calor

```{r}
#| title: Densidad de Propiedades

heatmap_data <- listings |>
  st_drop_geometry() |>
  st_as_sf(coords = c("geometry_lon", "geometry_lat"), crs = 4326)

maplibre(
  style = "https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json",
  center = merida_center,
  zoom = 11
) |>
  add_source(id = "heat", data = heatmap_data) |>
  add_layer(
    id = "heatmap",
    source = "heat",
    type = "heatmap",
    paint = list(
      "heatmap-intensity" = list(
        "interpolate", list("linear"), list("zoom"),
        0, 1, 15, 2.5
      ),
      "heatmap-color" = list(
        "interpolate", list("linear"), list("heatmap-density"),
        0, "rgba(33,102,172,0)",
        0.2, "rgb(103,169,207)",
        0.4, "rgb(209,229,240)",
        0.6, "rgb(253,219,199)",
        0.8, "rgb(239,138,98)",
        1, "rgb(178,24,43)"
      ),
      "heatmap-radius" = list(
        "interpolate", list("linear"), list("zoom"),
        0, 12, 12, 25, 16, 40
      ),
      "heatmap-opacity" = 0.85
    )
  ) |>
  add_navigation_control(position = "top-right") |>
  add_continuous_legend(
    legend_title = "Densidad de Propiedades",
    values = c(0, 50, 100),
    colors = c("#6ba6cd", "#ef8a62", "#b2182b"),
    position = "bottom-right"
  )
```

## Column {width=60%}

### Mapa por Zonas

```{r}
#| title: Clasificación por Distancia al Centro

zones_map_popup <- property_locations |>
  st_drop_geometry() |>
  mutate(
    popup_info = paste0(
      "<div style='font-family: Arial; max-width: 200px; padding: 6px;'>",
      "<h4 style='margin: 0 0 6px 0; color: #1f2937;'>Propiedad</h4>",
      "<p style='margin: 3px 0; font-size: 12px;'><strong>Zona:</strong> ", zone_classification, "</p>",
      "<p style='margin: 3px 0; font-size: 12px;'><strong>Distancia:</strong> ", round(distance_to_center_km, 1), " km</p>",
      "</div>"
    )
  ) |>
  st_as_sf(coords = c("geometry_lon", "geometry_lat"), crs = 4326)

maplibre(
  style = "https://basemaps.cartocdn.com/gl/positron-gl-style/style.json",
  center = merida_center,
  zoom = 10.8
) |>
  add_circle_layer(
    id = "zone-points",
    source = zones_map_popup,
    circle_radius = list(
      "interpolate", list("linear"), list("zoom"),
      8, 3, 12, 6, 16, 12
    ),
    circle_color = list(
      "match",
      list("get", "zone_classification"),
      "Centro", "#10b981",
      "Zona Media", "#3b82f6",
      "Zona Periférica", "#f59e0b",
      "Zona Remota", "#ef4444",
      "#64748b"
    ),
    circle_opacity = 0.8,
    circle_stroke_width = 2,
    circle_stroke_color = "#ffffff",
    popup = "popup_info"
  ) |>
  add_categorical_legend(
    legend_title = "Clasificación por Distancia",
    values = c("Centro", "Zona Media", "Zona Periférica", "Zona Remota"),
    colors = c("#10b981", "#3b82f6", "#f59e0b", "#ef4444"),
    position = "bottom-left"
  )
```

# NSE y Densidad

### NSE por Hexágono

```{r}
hex_soc_popup <- hex_demographics |>
  filter(!is.na(nse_percentil)) |>
  mutate(
    popup_info = paste0(
      "<div style='font-family: Arial; max-width: 220px; padding: 6px;'>",
      "<h4 style='margin: 0 0 6px 0; color: #111827;'>Contexto socioeconómico</h4>",
      "<p style='margin: 3px 0; font-size: 12px;'><strong>Percentil NSE:</strong> ",
      round(nse_percentil, 1), "</p>",
      "<p style='margin: 3px 0; font-size: 12px;'><strong>Score:</strong> ",
      round(nse_score, 2), "</p>",
      "<p style='margin: 3px 0; font-size: 12px;'><strong>Modal:</strong> ",
      nse_categoria_modal, "</p>",
      "<p style='margin: 3px 0; font-size: 12px;'><strong>Densidad poblacional:</strong> ",
      if_else(is.finite(pop_density_km2), paste0(round(pop_density_km2, 1), " hab/km²"), "Sin datos"),
      "</p>",
      "</div>"
    )
  )

if (nrow(hex_soc_popup) == 0) {
  "No hay datos para mostrar."
} else {
  nse_breaks <- quantile(hex_soc_popup$nse_percentil, probs = c(0.1, 0.3, 0.5, 0.7, 0.9), na.rm = TRUE)
  nse_colors <- c("#172554", "#1d4ed8", "#2563eb", "#fbbf24", "#fb7185")
  maplibre(
    style = "https://basemaps.cartocdn.com/gl/positron-gl-style/style.json",
    center = merida_center,
    zoom = 10.6
  ) |>
    add_fill_layer(
      id = "hex-nse",
      source = hex_soc_popup,
      fill_color = list(
        "interpolate", list("linear"), list("get", "nse_percentil"),
        nse_breaks[[1]], nse_colors[1],
        nse_breaks[[2]], nse_colors[2],
        nse_breaks[[3]], nse_colors[3],
        nse_breaks[[4]], nse_colors[4],
        nse_breaks[[5]], nse_colors[5]
      ),
      fill_opacity = 0.78,
      fill_outline_color = "#f1f5f9",
      popup = "popup_info"
    ) |>
    add_continuous_legend(
      legend_title = "Percentil NSE",
      values = round(as.numeric(nse_breaks), 1),
      colors = nse_colors,
      position = "bottom-right"
    ) |>
    add_navigation_control(position = "top-right")
}
```

### Densidad Poblacional

```{r}
hex_density_popup <- hex_demographics |>
  filter(!is.na(pop_density_km2), pop_density_km2 > 0) |>
  mutate(
    popup_info = paste0(
      "<div style='font-family: Arial; max-width: 220px; padding: 6px;'>",
      "<h4 style='margin: 0 0 6px 0; color: #111827;'>Densidad poblacional</h4>",
      "<p style='margin: 3px 0; font-size: 12px;'><strong>Habitantes/km²:</strong> ",
      round(pop_density_km2, 1), "</p>",
      "<p style='margin: 3px 0; font-size: 12px;'><strong>Hogares/km²:</strong> ",
      if_else(!is.na(households_density), as.character(round(households_density, 1)), "Sin datos"), "</p>",
      "</div>"
    )
  )

if (nrow(hex_density_popup) == 0) {
  "Sin datos de densidad."
} else {
  density_breaks <- quantile(hex_density_popup$pop_density_km2, probs = c(0.1, 0.3, 0.5, 0.7, 0.9), na.rm = TRUE)
  density_colors <- c("#fef2f2", "#fecaca", "#f87171", "#dc2626", "#7f1d1d")
  maplibre(
    style = "https://basemaps.cartocdn.com/gl/voyager-gl-style/style.json",
    center = merida_center,
    zoom = 10.6
  ) |>
    add_fill_layer(
      id = "hex-density",
      source = hex_density_popup,
      fill_color = list(
        "interpolate", list("linear"), list("get", "pop_density_km2"),
        density_breaks[[1]], density_colors[1],
        density_breaks[[2]], density_colors[2],
        density_breaks[[3]], density_colors[3],
        density_breaks[[4]], density_colors[4],
        density_breaks[[5]], density_colors[5]
      ),
      fill_opacity = 0.78,
      fill_outline_color = "#fee2e2",
      popup = "popup_info"
    ) |>
    add_continuous_legend(
      legend_title = "Habitantes por km²",
      values = round(as.numeric(density_breaks), 0),
      colors = density_colors,
      position = "bottom-left"
    ) |>
    add_navigation_control(position = "top-right")
}
```

# Capital Humano

### Educación y Capital Humano

```{r}
hex_education_popup <- hex_demographics |>
  filter(!is.na(escolaridad_promedio)) |>
  mutate(
    popup_info = paste0(
      "<div style='font-family: Arial; max-width: 220px; padding: 6px;'>",
      "<h4 style='margin: 0 0 6px 0; color: #111827;'>Educación</h4>",
      "<p style='margin: 3px 0; font-size: 12px;'><strong>Escolaridad promedio:</strong> ",
      round(escolaridad_promedio, 1), " años</p>",
      "<p style='margin: 3px 0; font-size: 12px;'><strong>% Educación superior:</strong> ",
      round(pct_educacion_superior, 1), "%</p>",
      "<p style='margin: 3px 0; font-size: 12px;'><strong>% Sin escolaridad:</strong> ",
      round(pct_sin_escolaridad, 1), "%</p>",
      "</div>"
    )
  )

if (nrow(hex_education_popup) == 0) {
  "No hay datos de educación."
} else {
  edu_breaks <- quantile(hex_education_popup$pct_educacion_superior, probs = c(0.1, 0.3, 0.5, 0.7, 0.9), na.rm = TRUE)
  edu_colors <- c("#f7fee7", "#bef264", "#84cc16", "#4d7c0f", "#365314")
  maplibre(
    style = "https://basemaps.cartocdn.com/gl/positron-gl-style/style.json",
    center = merida_center,
    zoom = 10.6
  ) |>
    add_fill_layer(
      id = "hex-education",
      source = hex_education_popup,
      fill_color = list(
        "interpolate", list("linear"), list("get", "pct_educacion_superior"),
        edu_breaks[[1]], edu_colors[1],
        edu_breaks[[2]], edu_colors[2],
        edu_breaks[[3]], edu_colors[3],
        edu_breaks[[4]], edu_colors[4],
        edu_breaks[[5]], edu_colors[5]
      ),
      fill_opacity = 0.8,
      fill_outline_color = "#d9f99d",
      popup = "popup_info"
    ) |>
    add_continuous_legend(
      legend_title = "% con educación superior",
      values = round(as.numeric(edu_breaks), 1),
      colors = edu_colors,
      position = "bottom-right"
    ) |>
    add_navigation_control(position = "top-right")
}
```

### Cobertura Seguridad Social

```{r}
hex_social_popup <- hex_demographics |>
  filter(!is.na(pct_seguridad_social)) |>
  mutate(
    popup_info = paste0(
      "<div style='font-family: Arial; max-width: 220px; padding: 6px;'>",
      "<h4 style='margin: 0 0 6px 0; color: #111827;'>Seguridad social</h4>",
      "<p style='margin: 3px 0; font-size: 12px;'><strong>Afiliación:</strong> ",
      round(pct_seguridad_social, 1), "%</p>",
      "<p style='margin: 3px 0; font-size: 12px;'><strong>NSE modal:</strong> ",
      coalesce(nse_categoria_modal, "s/d"), "</p>",
      "</div>"
    )
  )

if (nrow(hex_social_popup) == 0) {
  "Sin datos de seguridad social."
} else {
  soc_breaks <- quantile(hex_social_popup$pct_seguridad_social, probs = c(0.1, 0.3, 0.5, 0.7, 0.9), na.rm = TRUE)
  soc_colors <- c("#fff7ed", "#fdba74", "#fb923c", "#ea580c", "#9a3412")
  maplibre(
    style = "https://basemaps.cartocdn.com/gl/voyager-gl-style/style.json",
    center = merida_center,
    zoom = 10.6
  ) |>
    add_fill_layer(
      id = "hex-socsec",
      source = hex_social_popup,
      fill_color = list(
        "interpolate", list("linear"), list("get", "pct_seguridad_social"),
        soc_breaks[[1]], soc_colors[1],
        soc_breaks[[2]], soc_colors[2],
        soc_breaks[[3]], soc_colors[3],
        soc_breaks[[4]], soc_colors[4],
        soc_breaks[[5]], soc_colors[5]
      ),
      fill_opacity = 0.78,
      fill_outline_color = "#fed7aa",
      popup = "popup_info"
    ) |>
    add_continuous_legend(
      legend_title = "% con seguridad social",
      values = round(as.numeric(soc_breaks), 1),
      colors = soc_colors,
      position = "bottom-left"
    ) |>
    add_navigation_control(position = "top-right")
}
```

# Medio Ambiente

### Cobertura Verde

```{r}
hex_env_popup <- hex_environment |>
  filter(!is.na(ndvi_lluvias_mean)) |>
  mutate(
    popup_info = paste0(
      "<div style='font-family: Arial; max-width: 220px; padding: 6px;'>",
      "<h4 style='margin: 0 0 6px 0; color: #111827;'>Índice de vegetación</h4>",
      "<p style='margin: 3px 0; font-size: 12px;'><strong>NDVI Lluvias:</strong> ",
      round(ndvi_lluvias_mean, 3), "</p>",
      "<p style='margin: 3px 0; font-size: 12px;'><strong>NDVI Secas:</strong> ",
      round(ndvi_secas_mean, 3), "</p>",
      "<p style='margin: 3px 0; font-size: 12px;'><strong>Promedio veg:</strong> ",
      round(promedio_veg, 3), "</p>",
      "<p style='margin: 3px 0; font-size: 12px;'><strong>Rango estacional:</strong> ",
      round(ndvi_amplitude, 3), "</p>",
      "</div>"
    )
  )

if (nrow(hex_env_popup) == 0) {
  "Sin datos de NDVI."
} else {
  ndvi_breaks <- quantile(hex_env_popup$ndvi_lluvias_mean, probs = c(0.1, 0.3, 0.5, 0.7, 0.9), na.rm = TRUE)
  ndvi_colors <- c("#fef9c3", "#bef264", "#4ade80", "#16a34a", "#166534")
  maplibre(
    style = "https://basemaps.cartocdn.com/gl/voyager-gl-style/style.json",
    center = merida_center,
    zoom = 10.6
  ) |>
    add_fill_layer(
      id = "hex-ndvi",
      source = hex_env_popup,
      fill_color = list(
        "interpolate", list("linear"), list("get", "ndvi_lluvias_mean"),
        ndvi_breaks[[1]], ndvi_colors[1],
        ndvi_breaks[[2]], ndvi_colors[2],
        ndvi_breaks[[3]], ndvi_colors[3],
        ndvi_breaks[[4]], ndvi_colors[4],
        ndvi_breaks[[5]], ndvi_colors[5]
      ),
      fill_opacity = 0.75,
      fill_outline_color = "#ecfccb",
      popup = "popup_info"
    ) |>
    add_continuous_legend(
      legend_title = "NDVI (Temporada de lluvias)",
      values = round(as.numeric(ndvi_breaks), 3),
      colors = ndvi_colors,
      position = "bottom-left"
    ) |>
    add_navigation_control(position = "top-right")
}
```

### Temperatura Promedio

```{r}
hex_temp_popup <- hex_environment |>
  filter(!is.na(prom_temp)) |>
  mutate(
    popup_info = paste0(
      "<div style='font-family: Arial; max-width: 220px; padding: 6px;'>",
      "<h4 style='margin: 0 0 6px 0; color: #111827;'>Temperatura promedio</h4>",
      "<p style='margin: 3px 0; font-size: 12px;'><strong>Promedio anual:</strong> ",
      round(prom_temp, 1), "°C</p>",
      "<p style='margin: 3px 0; font-size: 12px;'><strong>NDVI lluvias:</strong> ",
      round(ndvi_lluvias_mean, 3), "</p>",
      "<p style='margin: 3px 0; font-size: 12px;'><strong>NDVI secas:</strong> ",
      round(ndvi_secas_mean, 3), "</p>",
      "</div>"
    )
  )

if (nrow(hex_temp_popup) == 0) {
  "Sin datos térmicos."
} else {
  temp_breaks <- quantile(hex_temp_popup$prom_temp, probs = c(0.1, 0.3, 0.5, 0.7, 0.9), na.rm = TRUE)
  temp_colors <- c("#dcfce7", "#a7f3d0", "#fde68a", "#fb923c", "#b91c1c")
  maplibre(
    style = "https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json",
    center = merida_center,
    zoom = 10.6
  ) |>
    add_fill_layer(
      id = "hex-temp",
      source = hex_temp_popup,
      fill_color = list(
        "interpolate", list("linear"), list("get", "prom_temp"),
        temp_breaks[[1]], temp_colors[1],
        temp_breaks[[2]], temp_colors[2],
        temp_breaks[[3]], temp_colors[3],
        temp_breaks[[4]], temp_colors[4],
        temp_breaks[[5]], temp_colors[5]
      ),
      fill_opacity = 0.75,
      fill_outline_color = "#fef08a",
      popup = "popup_info"
    ) |>
    add_continuous_legend(
      legend_title = "Temperatura °C",
      values = round(as.numeric(temp_breaks), 1),
      colors = temp_colors,
      position = "bottom-right"
    ) |>
    add_navigation_control(position = "top-right")
}
```

# Movilidad

### Cobertura de Transporte Público

```{r}
hex_mobility_popup <- hex_mobility |>
  filter(!is.na(num_paradas) | !is.na(num_rutas)) |>
  mutate(
    popup_info = paste0(
      "<div style='font-family: Arial; max-width: 220px; padding: 6px;'>",
      "<h4 style='margin: 0 0 6px 0; color: #111827;'>Transporte público</h4>",
      "<p style='margin: 3px 0; font-size: 12px;'><strong>Paradas:</strong> ",
      coalesce(as.character(num_paradas), "Sin datos"), "</p>",
      "<p style='margin: 3px 0; font-size: 12px;'><strong>Rutas:</strong> ",
      coalesce(as.character(num_rutas), "Sin datos"), "</p>",
      "<p style='margin: 3px 0; font-size: 12px;'><strong>Rutas/Parada:</strong> ",
      if_else(!is.na(routes_per_stop), as.character(round(routes_per_stop, 2)), "Sin datos"), "</p>",
      "</div>"
    )
  )

if (nrow(hex_mobility_popup) == 0) {
  "No hay datos de movilidad."
} else {
  maplibre(
    style = "https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json",
    center = merida_center,
    zoom = 10.6
  ) |>
    add_fill_layer(
      id = "hex-transit",
      source = hex_mobility_popup,
      fill_color = list(
        "match",
        list("get", "transit_category"),
        "Alta", "#16a34a",
        "Media", "#fde047",
        "Baja", "#f97316",
        "Sin datos", "#94a3b8",
        "#94a3b8"
      ),
      fill_opacity = 0.72,
      fill_outline_color = "#0f172a",
      popup = "popup_info"
    ) |>
    add_categorical_legend(
      legend_title = "Cobertura de rutas",
      values = c("Alta", "Media", "Baja", "Sin datos"),
      colors = c("#16a34a", "#fde047", "#f97316", "#94a3b8"),
      position = "bottom-right"
    ) |>
    add_navigation_control(position = "top-right")
}
```

### Rutas por Parada

```{r}
hex_routes_popup <- hex_mobility |>
  filter(!is.na(routes_per_stop), routes_per_stop > 0) |>
  mutate(
    popup_info = paste0(
      "<div style='font-family: Arial; max-width: 220px; padding: 6px;'>",
      "<h4 style='margin: 0 0 6px 0; color: #111827;'>Intensidad de rutas</h4>",
      "<p style='margin: 3px 0; font-size: 12px;'><strong>Rutas/Parada:</strong> ",
      round(routes_per_stop, 2), "</p>",
      "<p style='margin: 3px 0; font-size: 12px;'><strong>Rutas totales:</strong> ",
      coalesce(as.character(num_rutas), "Sin datos"), "</p>",
      "</div>"
    )
  )

if (nrow(hex_routes_popup) == 0) {
  "Sin datos de intensidad."
} else {
  routes_breaks <- quantile(hex_routes_popup$routes_per_stop, probs = c(0.1, 0.3, 0.5, 0.7, 0.9), na.rm = TRUE)
  routes_colors <- c("#e0f2fe", "#7dd3fc", "#38bdf8", "#0ea5e9", "#0c4a6e")
  maplibre(
    style = "https://basemaps.cartocdn.com/gl/positron-gl-style/style.json",
    center = merida_center,
    zoom = 10.6
  ) |>
    add_fill_layer(
      id = "hex-routes",
      source = hex_routes_popup,
      fill_color = list(
        "interpolate", list("linear"), list("get", "routes_per_stop"),
        routes_breaks[[1]], routes_colors[1],
        routes_breaks[[2]], routes_colors[2],
        routes_breaks[[3]], routes_colors[3],
        routes_breaks[[4]], routes_colors[4],
        routes_breaks[[5]], routes_colors[5]
      ),
      fill_opacity = 0.76,
      fill_outline_color = "#bae6fd",
      popup = "popup_info"
    ) |>
    add_continuous_legend(
      legend_title = "Rutas por parada",
      values = round(as.numeric(routes_breaks), 2),
      colors = routes_colors,
      position = "bottom-left"
    ) |>
    add_navigation_control(position = "top-right")
}
```

## Ranking de Hexágonos

### Top Hexágonos por Rutas

```{r}
mobility_table <- hex_mobility |>
  st_drop_geometry() |>
  filter(!is.na(num_paradas), num_paradas > 0) |>
  mutate(
    routes_per_stop = round(routes_per_stop, 2)
  ) |>
  arrange(desc(num_paradas), desc(num_rutas)) |>
  select(
    Hex = H3HASH,
    `Paradas` = num_paradas,
    `Rutas` = num_rutas,
    `Rutas/Parada` = routes_per_stop,
    `Categoría` = transit_category
  ) |>
  head(15)

if (nrow(mobility_table) == 0) {
  "No hay hexágonos con datos de rutas."
} else {
  datatable(
    mobility_table,
    options = list(pageLength = 5, dom = 'tip', order = list(list(1, 'desc'))),
    rownames = FALSE,
    class = 'cell-border stripe hover'
  )
}
```

# Clusters

## Mapa de Clusters

```{r}
#| title: Zonas de mayor presencia

if (nrow(clusters_sf) == 0) {
  "No hay datos suficientes para generar clusters."
} else {
  cluster_points <- clusters_sf |>
    mutate(
      cluster_label = paste0("Cluster ", cluster_id),
      popup_info = paste0(
        "<div style='font-family: Arial; max-width: 240px; padding: 6px;'>",
        "<h4 style='margin: 0 0 6px 0; color: #1f2937;'>", substr(name, 1, 32),
        if_else(nchar(name) > 32, "...", ""), "</h4>",
        "<p style='margin: 3px 0; font-size: 12px;'><strong>Cluster:</strong> ", cluster_label, "</p>",
        "<p style='margin: 3px 0; font-size: 12px;'><strong>Precio:</strong> $", round(precio_total, 0), " MXN</p>",
        "<p style='margin: 3px 0; font-size: 12px;'><strong>Por noche:</strong> $", round(price_per_night, 0), " MXN</p>",
        "</div>"
      )
    )
  cluster_centers <- cluster_summary_sf |>
    mutate(
      cluster_label = paste0("Cluster ", cluster_id),
      popup_info = paste0(
        "<div style='font-family: Arial; max-width: 220px; padding: 6px;'>",
        "<h4 style='margin: 0 0 6px 0; color: #111827;'>", cluster_label, "</h4>",
        "<p style='margin: 3px 0; font-size: 12px;'><strong>Propiedades:</strong> ",
        format(total_properties, big.mark = ","), "</p>",
        "<p style='margin: 3px 0; font-size: 12px;'><strong>Precio promedio:</strong> $",
        round(avg_price, 0), " MXN</p>",
        "<p style='margin: 3px 0; font-size: 12px;'><strong>Rating promedio:</strong> ",
        if_else(is.na(avg_rating), "s/d", paste0(round(avg_rating, 2), "/5.0")), "</p>",
        "</div>"
      )
    )
  cluster_colors <- setNames(viridis(length(unique(cluster_points$cluster_label))), sort(unique(cluster_points$cluster_label)))
  color_pairs <- as.list(unlist(mapply(c, names(cluster_colors), unname(cluster_colors))))
  color_match_expr <- c(
    list("match", list("get", "cluster_label")),
    color_pairs,
    list("#475569")
  )
  maplibre(
    style = "https://basemaps.cartocdn.com/gl/voyager-gl-style/style.json",
    center = merida_center,
    zoom = 11
  ) |>
    add_circle_layer(
      id = "cluster-points",
      source = cluster_points,
      circle_radius = list(
        "interpolate", list("linear"), list("zoom"),
        9, 2.5, 12, 5, 15, 9
      ),
      circle_color = color_match_expr,
      circle_opacity = 0.65,
      circle_stroke_width = 1,
      circle_stroke_color = "#ffffff",
      popup = "popup_info"
    ) |>
    add_circle_layer(
      id = "cluster-centers",
      source = cluster_centers,
      circle_radius = list(
        "interpolate", list("linear"), list("get", "total_properties"),
        10, 6, 250, 16
      ),
      circle_color = "#111827",
      circle_opacity = 0.7,
      circle_stroke_width = 3,
      circle_stroke_color = "#facc15",
      popup = "popup_info"
    ) |>
    add_categorical_legend(
      legend_title = "Clusters detectados",
      values = names(cluster_colors),
      colors = unname(cluster_colors),
      position = "bottom-right"
    ) |>
    add_navigation_control(position = "top-right")
}
```

## Top Clusters

```{r}
if (nrow(cluster_summary) == 0) {
  "Sin datos suficientes para resumir clusters."
} else {
  cluster_summary |> 
    mutate(
      cluster_label = paste0("Cluster ", cluster_id)
    ) |>
    select(
      Cluster = cluster_label,
      `Propiedades` = total_properties,
      `Precio Promedio` = avg_price,
      `$/Noche Prom.` = avg_price_per_night,
      `Rating Prom.` = avg_rating,
      `Mediana Precio` = median_price
    ) |>
    datatable(
      options = list(pageLength = 6, dom = "tip"),
      rownames = FALSE,
      class = 'cell-border stripe hover'
    ) |>
    formatCurrency(c("Precio Promedio", "$/Noche Prom.", "Mediana Precio"), currency = "$", digits = 0, mark = ",") |>
    formatRound("Rating Prom.", digits = 2)
}
```

# Mapas Especializados

## Row

### Mapa de Calor por Precios

```{r}
#| title: Concentración de Propiedades por Precio

price_heatmap <- listings |>
  st_drop_geometry() |>
  filter(precio_total > 0) |>
  st_as_sf(coords = c("geometry_lon", "geometry_lat"), crs = 4326)

maplibre(
  style = "https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json",
  center = merida_center,
  zoom = 11
) |>
  add_source(id = "price-heat", data = price_heatmap) |>
  add_layer(
    id = "price-heatmap",
    source = "price-heat",
    type = "heatmap",
    paint = list(
      "heatmap-weight" = list(
        "interpolate", list("linear"), list("get", "precio_total"),
        0, 0, 3000, 1
      ),
      "heatmap-intensity" = list(
        "interpolate", list("linear"), list("zoom"),
        0, 1, 15, 3
      ),
      "heatmap-color" = list(
        "interpolate", list("linear"), list("heatmap-density"),
        0, "rgba(16,185,129,0)",
        0.2, "rgba(16,185,129,0.3)",
        0.4, "rgba(59,130,246,0.5)",
        0.6, "rgba(99,102,241,0.6)",
        0.8, "rgba(168,85,247,0.7)",
        1, "rgba(236,72,153,0.9)"
      ),
      "heatmap-radius" = list(
        "interpolate", list("linear"), list("zoom"),
        0, 15, 12, 25, 16, 35
      ),
      "heatmap-opacity" = 0.8
    )
  ) |>
  add_navigation_control(position = "top-right") |>
  add_continuous_legend(
    legend_title = "Intensidad de Precios",
    values = c(0, 1500, 3000),
    colors = c("#16a34a", "#6366f1", "#ec4899"),
    position = "bottom-left"
  )
```

### Mapa por Capacidad

```{r}
#| title: Propiedades por Número de Dormitorios

capacity_map_popup <- property_capacity |>
  st_drop_geometry() |>
  filter(!is.na(num_bedrooms), num_bedrooms <= 6) |>
  mutate(
    popup_info = paste0(
      "<div style='font-family: Arial; max-width: 200px; padding: 6px;'>",
      "<h4 style='margin: 0 0 6px 0; color: #1f2937;'>Propiedad</h4>",
      "<p style='margin: 3px 0; font-size: 12px;'><strong>Dormitorios:</strong> ", num_bedrooms, "</p>",
      "<p style='margin: 3px 0; font-size: 12px;'><strong>Camas:</strong> ", num_beds, "</p>",
      "<p style='margin: 3px 0; font-size: 12px;'><strong>Eficiencia:</strong> ", round(capacity_efficiency_ratio, 2), "</p>",
      "</div>"
    )
  ) |>
  st_as_sf(coords = c("geometry_lon", "geometry_lat"), crs = 4326)

maplibre(
  style = "https://basemaps.cartocdn.com/gl/positron-gl-style/style.json",
  center = merida_center,
  zoom = 11
) |>
  add_circle_layer(
    id = "capacity-points",
    source = capacity_map_popup,
    circle_radius = list(
      "interpolate", list("linear"), list("get", "num_bedrooms"),
      1, 4, 6, 16
    ),
    circle_color = list(
      "interpolate", list("linear"), list("get", "num_bedrooms"),
      1, "#10b981",
      2, "#3b82f6",
      3, "#f59e0b",
      4, "#ef4444",
      6, "#8b5cf6"
    ),
    circle_opacity = 0.7,
    circle_stroke_width = 1,
    circle_stroke_color = "#ffffff",
    popup = "popup_info"
  ) |>
  add_continuous_legend(
    legend_title = "Número de Dormitorios",
    values = c(1, 2, 3, 4, 5, 6),
    colors = c("#10b981", "#3b82f6", "#f59e0b", "#ef4444", "#8b5cf6", "#8b5cf6"),
    position = "bottom-right"
  )
```

## Row

### Superhosts vs Anfitriones Regulares

```{r}
#| title: Distribución de Superhosts

superhost_map_popup <- superhost_analysis |>
  st_drop_geometry() |>
  filter(!is.na(host_is_superhost)) |>
  mutate(
    popup_info = paste0(
      "<div style='font-family: Arial; max-width: 220px; padding: 6px;'>",
      "<h4 style='margin: 0 0 6px 0; color: #1f2937;'>", substr(host_name, 1, 30),
      if_else(nchar(host_name) > 30, "...", ""), "</h4>",
      "<p style='margin: 3px 0; font-size: 12px;'><strong>Tipo:</strong> ",
      if_else(host_is_superhost, "Superhost", "Anfitrión Regular"), "</p>",
      "<p style='margin: 3px 0; font-size: 12px;'><strong>Rating:</strong> ",
      round(host_rating_average, 1), "/5.0</p>",
      "<p style='margin: 3px 0; font-size: 12px;'><strong>Años hosting:</strong> ", host_years_hosting, "</p>",
      "</div>"
    )
  ) |>
  st_as_sf(coords = c("geometry_lon", "geometry_lat"), crs = 4326)

maplibre(
  style = "https://basemaps.cartocdn.com/gl/voyager-gl-style/style.json",
  center = merida_center,
  zoom = 11
) |>
  add_circle_layer(
    id = "superhost-points",
    source = superhost_map_popup,
    circle_radius = list(
      "interpolate", list("linear"), list("zoom"),
      8, 4, 12, 7, 16, 12
    ),
    circle_color = list(
      "case",
      list("==", list("get", "host_is_superhost"), TRUE), "#f59e0b",
      "#64748b"
    ),
    circle_opacity = 0.8,
    circle_stroke_width = 2,
    circle_stroke_color = "#ffffff",
    popup = "popup_info"
  ) |>
  add_categorical_legend(
    legend_title = "Estado del Anfitrión",
    values = c("Superhost", "Anfitrión Regular"),
    colors = c("#f59e0b", "#64748b"),
    position = "top-left"
  )
```

### Análisis de Reseñas

```{r}
#| title: Propiedades por Cantidad de Reseñas

reviews_map_popup <- listings |>
  st_drop_geometry() |>
  filter(num_reseñas > 0) |>
  mutate(
    categoria_reseñas = case_when(
      num_reseñas < 5 ~ "Pocas (1-4)",
      num_reseñas < 20 ~ "Moderadas (5-19)",
      num_reseñas < 50 ~ "Muchas (20-49)",
      TRUE ~ "Abundantes (50+)"
    ),
    popup_info = paste0(
      "<div style='font-family: Arial; max-width: 200px; padding: 6px;'>",
      "<h4 style='margin: 0 0 6px 0; color: #1f2937;'>", substr(name, 1, 30),
      if_else(nchar(name) > 30, "...", ""), "</h4>",
      "<p style='margin: 3px 0; font-size: 12px;'><strong>Reseñas:</strong> ", num_reseñas, "</p>",
      "<p style='margin: 3px 0; font-size: 12px;'><strong>Calificación:</strong> ",
      if_else(calificacion > 0, paste0(round(calificacion, 1), "/5.0"), "Sin calificar"), "</p>",
      "<p style='margin: 3px 0; font-size: 12px;'><strong>Precio:</strong> $", round(precio_total, 2), " MXN</p>",
      "</div>"
    )
  ) |>
  st_as_sf(coords = c("geometry_lon", "geometry_lat"), crs = 4326)

maplibre(
  style = "https://basemaps.cartocdn.com/gl/voyager-gl-style/style.json",
  center = merida_center,
  zoom = 11
) |>
  add_circle_layer(
    id = "review-points",
    source = reviews_map_popup,
    circle_radius = list(
      "interpolate", list("linear"), list("get", "num_reseñas"),
      0, 3, 100, 12
    ),
    circle_color = list(
      "match",
      list("get", "categoria_reseñas"),
      "Pocas (1-4)", "#fbbf24",
      "Moderadas (5-19)", "#3b82f6",
      "Muchas (20-49)", "#10b981",
      "Abundantes (50+)", "#8b5cf6",
      "#64748b"
    ),
    circle_opacity = 0.7,
    circle_stroke_width = 1,
    circle_stroke_color = "#ffffff",
    popup = "popup_info"
  ) |>
  add_categorical_legend(
    legend_title = "Volumen de Reseñas",
    values = c("Pocas (1-4)", "Moderadas (5-19)", "Muchas (20-49)", "Abundantes (50+)"),
    colors = c("#fbbf24", "#3b82f6", "#10b981", "#8b5cf6"),
    position = "top-right"
  )
```

# Competitividad

## Row

### Matriz Precio-Calidad

```{r}
#| title: Análisis Competitivo

comp_data <- competitive_analysis |>
  st_drop_geometry() |>
  filter(!is.na(value_for_money_score), competitive_position != "Sin datos")

ggplotly(
  ggplot(comp_data, aes(
    x = price_percentile * 100,
    y = rating_percentile * 100,
    color = competitive_position,
    size = precio_total
  )) +
    geom_point(alpha = 0.6) +
    geom_hline(yintercept = 50, linetype = "dashed", color = "gray") +
    geom_vline(xintercept = 50, linetype = "dashed", color = "gray") +
    scale_color_manual(
      values = c(
        "Alto valor" = "#10b981",
        "Valor medio" = "#3b82f6",
        "Valor bajo" = "#ef4444"
      )
    ) +
    labs(
      x = "Percentil de Precio (%)",
      y = "Percentil de Calificación (%)",
      color = "Posición",
      size = "Precio"
    ) +
    theme_minimal()
)
```

### Distribución Competitiva

```{r}
#| title: Segmentos de Valor

pos_dist <- competitive_analysis |>
  st_drop_geometry() |>
  filter(competitive_position != "Sin datos") |>
  count(competitive_position) |>
  mutate(
    pct = round(n / sum(n) * 100, 1),
    competitive_position = factor(
      competitive_position,
      levels = c("Alto valor", "Valor medio", "Valor bajo")
    )
  )

ggplotly(
  ggplot(pos_dist, aes(x = competitive_position, y = n, fill = competitive_position)) +
    geom_col(width = 0.6) +
    geom_text(aes(label = paste0(format(n, big.mark = ","), "\n(", pct, "%)")),
              vjust = -0.5, size = 3.5) +
    scale_fill_manual(
      values = c(
        "Alto valor" = "#10b981",
        "Valor medio" = "#3b82f6",
        "Valor bajo" = "#ef4444"
      )
    ) +
    labs(x = NULL, y = "Cantidad") +
    theme_minimal() +
    theme(legend.position = "none") +
    ylim(0, max(pos_dist$n) * 1.15)
)
```

# Análisis Temporal

## Row

### Ventanas de Reserva

```{r}
#| title: Análisis por Período

booking_data <- booking_windows |>
  st_drop_geometry() |>
  mutate(periodo = paste(format(check_in, "%d/%m"), "-", format(check_out, "%d/%m")))

ggplotly(
  ggplot(booking_data, aes(x = periodo, y = avg_price_per_window)) +
    geom_col(fill = "#3b82f6", width = 0.7) +
    geom_line(aes(y = median_price, group = 1), color = "#ef4444", linewidth = 1.2) +
    geom_point(aes(y = median_price), color = "#ef4444", size = 3) +
    labs(x = "Período", y = "Precio (USD)", title = "Análisis por Ventanas de Reserva") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
)
```

### Duración vs Precio

```{r}
#| title: Eficiencia por Duración de Estadía

duration_data <- stay_duration |>
  st_drop_geometry() |>
  filter(stay_nights <= 7) |>
  mutate(stay_nights = as.factor(stay_nights))

ggplotly(
  ggplot(duration_data, aes(x = stay_nights, y = avg_price_per_night, fill = stay_nights)) +
    geom_col() +
    scale_fill_viridis_d(option = "turbo") +
    labs(x = "Duración (noches)", y = "Precio/Noche Promedio (USD)", title = "Precio por Duración de Estadía") +
    theme_minimal() +
    theme(legend.position = "none")
)
```
